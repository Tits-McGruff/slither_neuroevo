# Work Plan (Phase 8/10 follow-up, reliability & docs)

## Objectives
- Guard against regressions seen recently (first-gen invisibility, NaN sensors, render buffer skew).
- Add targeted tests around world boot, serializer→render pipeline, and fitness history sync.
- Improve inline comments for fragile areas (binary layout, camera/zoom, fitness accumulation).
- Refresh documentation to reflect current features (worker pipeline, fast-mode render, starfield/boost trails, Hall of Fame).
- Update Copilot guidelines to steer future changes away from buffer drift or CFG desync.

## Scope Breakdown
1) **Testing coverage for recent regressions**
   - Add a world boot test that runs one tick and asserts:
     - `bestPointsThisGen` is finite/non-NaN after update.
     - All snakes have finite head positions and sensor vectors without NaNs.
   - Add a serializer→render integration test:
     - Instantiate a World (with reduced pellet counts for speed), run one tick, serialize, and render via `renderWorldStruct` into a stub ctx.
     - Assert at least one snake path is drawn (line/arc calls) and pellet parsing succeeds.
   - Add a fitness-history propagation test:
     - Simulate a fake `msg.stats.fitnessHistory` payload in `main` and assert the chart buffer stores min/avg/max without truncation and caps size.
   - Add a guard test for boost trail rendering:
     - Call `renderWorldStruct` with a boosted snake and verify particle drawing calls occur (shadowBlur/arc for particles).
2) **Inline comments for high-fragility zones**
   - `src/render.js`: Document binary layout expectations (header, per-snake block, pellet block), pointer math, and particle buffer assumptions.
   - `src/world.js`: Comment why `bestPointsThisGen` must be initialized before any sensor pass and why it must stay finite.
   - `src/worker.js`: Note how fitness history is sliced and transferred; warn to update tests when changing stats payload.
   - `src/main.js`: Comment on fitness history merge logic and render loop’s dependency on worker camera/zoom (no overrides).
3) **Documentation updates**
   - `README.md`:
     - Describe worker-based architecture, binary frame layout, and fast-path rendering (starfield + boost trails).
     - Note testing workflow (`npm test`) and pitfalls (don’t break serializer layout; keep CFG/UI in sync).
     - Mention Hall of Fame tab and persistence caveats.
   - `.github/copilot-instructions.md`:
     - Update overview with current rendering pipeline, particle effects, fitness history, and worker stats/viz protocol.
     - Add explicit “do not” guidance: don’t change buffer layout without updating serializer/render/main tests; keep CFG/UI/worker alignment; maintain bestPoints initialization.
4) **Checklist sync**
   - Note completion of Phase 8 and Phase 10 tasks in updated guidance (Phase 8 visuals + Phase 10 analytics).
5) **Sanity pass**
   - Run targeted tests (or full `npm test` if feasible) and summarize results.

## Execution Order
1. Add tests (world boot, serializer→render, fitness history, boosted particle render).
2. Insert clarifying comments in render/world/worker/main.
3. Update README with current architecture/run/test notes.
4. Expand `.github/copilot-instructions.md` with new constraints/behaviors.
5. Run tests and report outcomes.

## Risk/Notes
- World instantiation is heavy; tests will temporarily lower pellet target for speed and restore CFG after.
- Keep binary layout docs in sync with serializer and render tests; avoid magic numbers in new tests. 
